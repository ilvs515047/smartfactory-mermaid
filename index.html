<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SmartFactory Mermaid 測試</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.9.0/mermaid.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
      background-color: #f4f4f4;
      padding: 40px;
      margin: 0;
    }
    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    .mermaid-container {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      overflow-x: auto;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    .error {
      background-color: #f8d7da;
      color: #721c24;
      padding: 20px;
      border-radius: 5px;
      border: 1px solid #f5c6cb;
    }
    .mermaid {
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>智慧工廠流程圖</h1>
    <div class="mermaid-container">
      <div id="mermaid-content" class="loading">正在載入圖表...</div>
    </div>
  </div>

  <script>
    // 初始化 Mermaid
    mermaid.initialize({ 
      startOnLoad: false,
      theme: 'default',
      flowchart: {
        nodeSpacing: 50,
        rankSpacing: 50,
        curve: 'basis'
      }
    });

    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS6GdK8TSivgQZ7nUuuvrpSfe0kUCklKHxkdA0sRnUteInqB8WVlzR-EELes6FM1LfkKlIS9_9fkHmH/pub?gid=0&single=true&output=csv";
    
    const classMap = {
      title: ":::title",
      node: ":::node", 
      layer: ":::layer",
      action: ":::action"
    };

    function sanitizeLabel(str) {
      return str.replace(/["]/g, '\\"').replace(/[●•・]/g, "").trim();
    }

    function parseCSV(text) {
      const lines = text.trim().split('\n');
      const result = [];
      
      for (let i = 1; i < lines.length; i++) { // 跳過標題行
        const line = lines[i];
        const row = [];
        let current = '';
        let inQuotes = false;
        
        for (let j = 0; j < line.length; j++) {
          const char = line[j];
          if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === ',' && !inQuotes) {
            row.push(current.trim());
            current = '';
          } else {
            current += char;
          }
        }
        row.push(current.trim());
        
        if (row.length >= 3) {
          result.push(row);
        }
      }
      
      return result;
    }

    async function drawMermaid() {
      try {
        const response = await fetch(csvUrl);
        if (!response.ok) {
          throw new Error(`HTTP 錯誤! 狀態碼: ${response.status}`);
        }
        
        const text = await response.text();
        const rows = parseCSV(text);
        
        if (rows.length === 0) {
          throw new Error('CSV 資料為空或格式不正確');
        }

        let mermaidText = `%%{init: { "flowchart": { "nodeSpacing": 50, "rankSpacing": 50 }}}%%\n`;
        mermaidText += `graph LR\n`;
        
        // 定義樣式
        mermaidText += `classDef title fill:#3c8dbc,stroke:#333,stroke-width:2px,color:#fff;\n`;
        mermaidText += `classDef node fill:#f9f9f9,stroke:#aaa,stroke-width:1px;\n`;
        mermaidText += `classDef layer fill:#fff,stroke:#999,stroke-dasharray: 5 5;\n`;
        mermaidText += `classDef action fill:#fdf6e3,stroke:#666,stroke-width:1px;\n`;
        
        // 處理節點和連接
        for (let row of rows) {
          const [id, label, type, from] = row;
          if (!id || !label || !type) continue;
          
          const cleanId = id.trim();
          const cleanLabel = sanitizeLabel(label);
          const cleanType = type.trim().toLowerCase();
          const cleanFrom = from ? from.trim() : "";
          
          // 添加節點
          mermaidText += `  ${cleanId}["${cleanLabel}"]${classMap[cleanType] || ""}\n`;
          
          // 添加連接
          if (cleanFrom) {
            mermaidText += `  ${cleanFrom} --> ${cleanId}\n`;
          }
        }
        
        // 渲染圖表
        const container = document.getElementById('mermaid-content');
        container.className = 'mermaid';
        container.innerHTML = mermaidText;
        
        await mermaid.run({
          nodes: [container]
        });
        
      } catch (error) {
        console.error("渲染 Mermaid 圖表時發生錯誤:", error);
        const container = document.getElementById('mermaid-content');
        container.className = 'error';
        container.innerHTML = `
          <h3>圖表載入失敗</h3>
          <p>錯誤訊息: ${error.message}</p>
          <p>請檢查網路連接和 CSV 資料格式</p>
        `;
      }
    }

    // 等待 DOM 完全載入後再執行
    document.addEventListener('DOMContentLoaded', drawMermaid);
  </script>
</body>
</html>
